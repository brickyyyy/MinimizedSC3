---
title: "28.01.2019"
author: "Valentina Hekimova"
date: "28 January 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir='C:/Users/valen/Documents/scRNA.seq')
```

## R Markdown
Load all require libraries and deng SingleCellExperiment object.

```{r}
library(pcaMethods)
library(pcaReduce)
library(SC3min)
library(scater)
library(SingleCellExperiment)
library(pheatmap)
library(mclust)
set.seed(1234567)
deng <- readRDS("deng/deng-reads.rds")
```

##Run SC3 on the Deng dataset.
```{r}
library(SC3)
dengSC3 = sc3(deng, ks=10)
```
## Break down SC3min workflow into steps
##Calculate distances between cells. 
We calculate Euclidean, Pearson and Spearman distances. The result of the calculations is a list, containing 3 square matrices with cell versus cell size. 
##Extract transformations. 
We calculate Laplacian transformations for the 3 distance matrices, produced in the previous step. We take a "d" range of eigenvectors from the transformations. The result is a list, containing 3 matrices with size cells x "d". In the case of the Deng dataset - 286x19. 

```{r}
library(SC3min)
dengMin = sc3min(deng, ks=10)
distances = metadata(dengMin)$sc3min$distances
transformations = metadata(dengMin)$sc3min$transformations
head(distances[["euclidean"]][,3])
head(transformations[["euclidean_laplacian"]][,3])
```
##Calculate k-means
The input for k-means is the list with 3 transformations, produced in the previous step and a k = 10.
The result of k-means for the Deng dataset is a list of 30 vectors with length equal to the number of cells in the dataset.
```{r}
library(SC3min)
dengMin = sc3min(deng, ks=10)
kMeans = metadata(dengMin)$sc3min$kmeans
kMeans[["euclidean_laplacian_10_10"]]
```
##Plot a couple of heatmaps for the different clustering results.
```{r}
library(pheatmap)
testVector = rbind(kMeans[[1]])
l = length(testVector)

FindSimilarities = function(v){
df = matrix(0L,nrow = l, ncol = l)
  for (i in 1:length(v)){
    for (j in 1:length(v)){
      if(v[i]==v[j]){
       df[i,j]<-1  
      }
    }
  }
return (df)
}
allDf = lapply(kMeans,FUN = FindSimilarities)
#sum all similarity matrices
cons = Reduce("+", allDf)

# colnames(df) = c(1:ncol(df))
# rownames(df) = c(1:nrow(df))
pheatmap(cons)
```
##Try to make similarity matrices and another consensus out of sc3min consensus
```{r}
library(SC3min)
dengMin = sc3min(deng, ks=10)
consensus = metadata(dengMin)$sc3min$consensus[["10"]][["consensus"]]
```
##
```{r}
library(plyr)
toList = alply(consensus,1)
allCons = lapply(toList,FUN = FindSimilarities)
sumOfCons = Reduce("+", allCons)
pheatmap(sumOfCons)
```
##Try to calculate ED2 distance and plot heatmap using implemented plotting function
```{r}
library(SC3min)
dengMin = sc3min(deng, ks=10)
sc3min_plot_consensus(dengMin, k = 10, show_pdata = "cell_type2")
```
##Compare to sc3
```{r}
library(SC3)
sc3_plot_consensus(dengSC3,k=10, show_pdata = "cell_type2")
```